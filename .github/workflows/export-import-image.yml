name: Export and Import Home Assistant ARM64 Image

on:
  workflow_dispatch:
    inputs:
      ha_version:
        description: 'Home Assistant version tag (e.g., 2025.12.5)'
        required: true
        default: '2025.12.5'
        type: string

env:
  HA_VERSION: ${{ inputs.ha_version }}
  IMAGE_NAME: home-assistant-arm64-slim

jobs:
  export-import:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pull Home Assistant ARM64 image
        run: |
          docker pull --platform linux/arm64 ghcr.io/home-assistant/home-assistant:${{ env.HA_VERSION }}

      - name: Start container and get container ID
        run: |
          CONTAINER_ID=$(docker run --platform linux/arm64 -d ghcr.io/home-assistant/home-assistant:${{ env.HA_VERSION }} sleep infinity)
          echo "CONTAINER_ID=${CONTAINER_ID}" >> $GITHUB_ENV
          echo "Started container with ID: ${CONTAINER_ID}"

      - name: Export container to tar file
        run: |
          docker export ${CONTAINER_ID} > ${{ env.IMAGE_NAME }}:${{ env.HA_VERSION }}.tar
          echo "Exported container to ${{ env.IMAGE_NAME }}:${{ env.HA_VERSION }}.tar"

      - name: Stop and remove container
        run: |
          docker stop ${CONTAINER_ID}
          docker rm ${CONTAINER_ID}
          echo "Stopped and removed container"

      - name: Import tar as new image
        run: |
          docker import ${{ env.IMAGE_NAME }}:${{ env.HA_VERSION }}.tar ${{ env.IMAGE_NAME }}:${{ env.HA_VERSION }}
          echo "Imported tar as ${{ env.IMAGE_NAME }}:${{ env.HA_VERSION }}"

      - name: Verify imported image
        run: |
          docker images ${{ env.IMAGE_NAME }}:${{ env.HA_VERSION }}

      - name: Save image
        run: |
          docker save ${{ env.IMAGE_NAME }}:${{ env.HA_VERSION }} -o ${{ env.IMAGE_NAME }}-${{ env.HA_VERSION }}-final.tar
          echo "Saved final image as ${{ env.IMAGE_NAME }}-${{ env.HA_VERSION }}-final.tar"

      - name: Upload image artifacts
        uses: actions/upload-artifact@v4
        with:
          name: home-assistant-image-${{ env.HA_VERSION }}
          path: |
            ${{ env.IMAGE_NAME }}-${{ env.HA_VERSION }}-final.tar
            ${{ env.IMAGE_NAME }}:${{ env.HA_VERSION }}.tar
          retention-days: 30