name: Build and Push Home Assistant ARM64 Slim Image

on:
  workflow_dispatch:
    inputs:
      ha_version:
        description: 'Home Assistant version tag (e.g., 2025.12.5)'
        required: true
        default: '2025.12.5'
        type: string

env:
  HA_VERSION: ${{ inputs.ha_version }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=${{ env.HA_VERSION }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Pull original image and get size
        run: |
          docker pull --platform linux/arm64 ghcr.io/home-assistant/home-assistant:${{ env.HA_VERSION }}
          ORIGINAL_SIZE=$(docker images --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}" ghcr.io/home-assistant/home-assistant:${{ env.HA_VERSION }} | tail -n 1 | awk '{print $2}')
          echo "ORIGINAL_SIZE=${ORIGINAL_SIZE}" >> $GITHUB_ENV
          echo "原始镜像大小: ${ORIGINAL_SIZE}"

      - name: Start container and get container ID
        run: |
          CONTAINER_ID=$(docker run --platform linux/arm64 -d ghcr.io/home-assistant/home-assistant:${{ env.HA_VERSION }} uv pip uninstall AEMET-OpenData AIOSomecomfort Adax-local DoorBirdPy HAP-python HATasmota HueBLE Mastodon.py PSNAWP Pillow PlexAPI ProgettiHWSW PyChromecast PyFlume PyFronius PyLoadAPI PyMetEireann PyMetno PyMicroBot PyNaCl PyQRCode PyRMVtransport PySrDaliGateway PySwitchbot PySwitchmate PySyncThru PyTransportNSW PyTurboJPEG PyViCare PyXiaomiGateway RachioPy RestrictedPython RtmAPI SQLAlchemy Tami4EdgeAPI TravisPy TwitterAPI WSDiscovery accuweather actron-neo-api adax adb-shell[async] adext adguardhome advantage-air afsapi agent-py aio-geojson-generic-client aio-geojson-geonetnz-quakes aio-geojson-geonetnz-volcano aio-geojson-nsw-rfs-incidents aio-geojson-usgs-earthquakes aio-georss-gdacs aio-ownet aioacaia aioairq aioairzone-cloud aioairzone aioamazondevices aioambient aioapcaccess aioaquacell aioaseko aioasuswrt aioautomower aioazuredevops aiobafi6 aiobotocore aiocomelit aiodhcpwatcher aiodiscover aiodns aiodukeenergy aioeafm aioeagle aioecowitt aioelectricitymaps aioemonitor aioesphomeapi aiofiles aioflo aioftp aiogithubapi aioguardian aioharmony aiohasupervisor aiohomeconnect aiohomekit aiohttp_sse aiohue aioimaplib aioimmich aiokafka aiokef aiokem aiolifx-effects aiolifx-themes aiolifx aiolookin aiolyric aiomealie aiomodernforms aiomusiccast aionanoleaf aionotion aiontfy aionut aioonkyo aioopenexchangerates aiooui aiopegelonline aiopulse aiopurpleair aiopvapi aiopvpc aiopyarr aioqsw aioraven aiorecollect aioridwell aioruckus aiorussound aioruuvigateway aiosenz aioshelly aioskybell aioslimproto aiosolaredge aiosteamist aiostreammagic aioswitcher aiosyncthing aiotankerkoenig aiotedee aiotractive aiounifi aiousbwatcher aiovlc aiovodafone aiowaqi aiowatttime aiowebdav2 aiowebostv aiowithings aioymaps airgradient airly airos airthings-ble airthings-cloud airtouch4pyapi airtouch5py alpha-vantage altruistclient amberelectric amcrest androidtv[async] androidtvremote2 anel-pwrctrl-homeassistant anova-wifi anthemav anthropic anyio apple_weatherkit apprise aprslib apsystems-ez1 aqualogic aranet4 arcam-fmj arris-tg2492lg asmog asusrouter async-upnp-client asyncarve asyncinotify asyncpysupla asyncsleepiq asyncssh # atenpdu auroranoaa aurorapy autarco automower-ble av avea # avion axis ayla-iot-unofficial azure-eventhub azure-kusto-data[aio] azure-kusto-ingest azure-servicebus azure-storage-blob b2sdk babel baidu-aip base36 batinfo beautifulsoup4 # beewi-smartclim bimmer-connected[china] bizkaibus bleak-esphome bleak-retry-connector bleak blebox-uniapi blinkpy blockchain bluecurrent-api bluemaestro-ble bluetooth-adapters bluetooth-auto-recovery bluetooth-data-tools bond-async bosch-alarm-mode2 boschshcpy boto3 botocore bring-api broadlink brother brottsplatskartan brunt bthome-ble bthomehub5-devicelist btsmarthub-devicelist buienradar cached-ipaddress caldav ciscomobilityexpress clearpasspy clx-sdk-xms coinbase-advanced-py colorlog colorthief compit-inext-api concord232 connect-box construct cookidoo-api cronsim crownstone-cloud crownstone-sse crownstone-uart datadog datapoint dbus-fast debugpy decora-wifi deebot-client defusedxml deluge-client demetriek denonavr devialet devolo-home-control-api devolo-plc-api dio-chacon-wifi-api directv discogs-client discovery30303 dremel3dpy dropmqttapi dsmr-parser dwdwfsapi dynalite-devices dynalite-panel eagle100 easyenergy ebusdpy ecoaliface eheimdigital ekey-bionyxpy electrickiwi-api elevenlabs elgato eliqonline elkm1-lib elkoep-aio-mqtt elmax-api elvia emoji emulated-roku energyflip-client energyid-webhooks energyzero enocean enturclient env-canada ephem epicstore-api epion epson-projector eq3btsmart esphome-dashboard-api essent-dynamic-pricing eternalegypt eufylife-ble-client # evdev evohome-async evolutionhttp faadelays fastdotcom feedparser file-read-backwards fing_agent_api fints fitbit-web-api fitbit fivem-api fixerio fjaraskupan flexit_bacnet flipr-api flux-led fnv-hash-fast foobot_async forecast-solar fortiosapi freebox-api freesms fressnapftracker fritzconnection[qr] fyta_cli gTTS gardena-bluetooth gassist-text gcal-sync genie-partner-sdk geniushub-client geocachingapi geopy georss-generic-client georss-ign-sismologia-client georss-qld-bushfire-alert-client getmac gios gitterpy glances-api go2rtc-client goalzero goodwe google-api-python-client google-cloud-pubsub google-cloud-speech google-cloud-texttospeech google-genai google-maps-routing google-nest-sdm google-photos-library-api google_air_quality_api goslide-api gotailwind govee-ble govee-local-api gpiozero gps3 greeclimate greeneye_monitor greenwavereality gridnet growattServer gspread guppy3 h2 ha-ffmpeg ha-iotawattpy ha-philipsjs ha-silabs-firmware-client habiticalib habluetooth hanna-cloud hass-nabucasa hass-splunk hassil hdate[astral] heatmiserV3 here-routing here-transit hikvision hkavr hko hlk-sw16 hole holidays home-assistant-frontend home-assistant-intents homelink-integration-api homematicip horimote httplib2 huawei-lte-api huum hyperion-py iammeter iaqualink ibeacon-ble ical icalendar icmplib idasen-ha ifaddr iglo igloohome-api ihcsdk imeon_inverter_api imgw_pib incomfort-client influxdb-client influxdb inkbird-ble insteon-frontend-home-assistant intellifire4py iometer iottycloud iperf3 irm-kmi-api isal ismartgate israel-rail-api jaraco.abode jellyfin-apiclient-python jsonpath justnimbus kaiterra-async-client keba-kecontact kegtron-ble kiwiki-client knocki knx-frontend konnected krakenex lacrosse-view lakeside laundrify-aio lcn-frontend ld2410-ble leaone-ble led-ble lektricowifi letpot libpyfoscamcgi libpyvivotek librehardwaremonitor-api librouteros libsoundtouch lightify lightwave limitlessled linode-api livisi locationsharinglib london-tube-status loqedAPI luftdaten lunatone-rest-api-client lupupy lw12 lxml matrix-nio maxcube-api mbddns mcp mcstatus meater-python medcom-ble melnor-bluetooth messagebird meteo-lt-pkg meteoalertapi meteofrance-api mficlient micloud microBeesPy mill-local millheater minio moat-ble moehlenhoff-alpha2 momonga monzopy mopeka-iot-ble motionblinds motionblindsble motioneye-client mozart-api mullvad-api music-assistant-client mutagen mutesync mvg mypermobil myuplink nad-receiver ndms2-client nessclient netdata netmap nettigo-air-monitor neurio nexia nextcloudmonitor nextcord nextdns nhc nibe nice-go niluclient noaa-coops notifications-android-tv notify-events nsapi nsw-fuel-api-client nuheat numato-gpio numpy nyt_games oasatelematics oauth2client objgraph odp-amsterdam oemthermostat ohme ollama omnilogic ondilo onedrive-personal-sdk onvif-zeep-async open-garage open-meteo openai openerz-api openevsewifi openhomedevice openrgb-python opensensemap-api openwebifpy openwrt-luci-rpc openwrt-ubus-rpc opower oralb-ble oru orvibo ourgroceries ovoenergy p1monitor paho-mqtt panacotta panasonic-viera pdunehd peblar peco pencompy pescea pexpect phone-modem pigpio pilight plexauth plexwebsocket plugwise pmsensor poolsense powerfox praw prayer-times-calculator-offline proliphix prometheus-client prowlpy proxmoxer psutil-home-assistant psutil pulsectl pushbullet.py pushover_complete pvo py-aosmith py-canary py-cpuinfo py-dactyl py-dormakaba-dkey py-improv-ble-client py-madvr2 py-melissa-climate py-nextbusnext py-nightscout py-schluter py-sucks py-synologydsm-api pyAtome pyCEC pyControl4 pyDuotecno pyElectra pyEmby pyHik pyHomee pyRFXtrx pySDCP pyTibber pyW215 pyW800rf32 py_ccm15 pyads pyaehw4a1 pyaftership pyairnow pyairobotrest pyairvisual pyanglianwater pyaprilaire pyatag pyatmo pyatv pyaussiebb pybalboa pybbox pyblackbird pyblu pybotvac pybravia pycarwings2 pycfdns pychannels pycketcasts pycmus pycomfoconnect pycoolmasternet-async pycountry pycsspeechtts pycync pydaikin pydanfossair pydeako pydeconz pydelijn pydexcom pydiscovergy pydoods pydrawise pydroid-ipcam pydroplet pyebox pyecoforest pyeconet pyecotrend-ista pyedimax pyefergy pyegps pyemoncms pyenphase pyenvisalink pyephember2 pyeverlights pyevilgenius pyezvizapi pyfibaro pyfido pyfirefly pyfireservicerota pyflic pyfnip pyforked-daapd pyfreedompro pyfritzhome pyfttt pygatt[GATTTOOL] pygtfs pygti pyhaversion pyheos pyhive-integration pyhomematic pyhomeworks pyialarm pyicloud pyinsteon pyintesishome pyipma pyipp pyiqvia pyirishrail pyiskra pyiss pyisy pyitachip2ir pyituran pyjvcprojector pykaleidescape pykira pykmtronic pykodi pykoplenti pykrakenapi pykulersky pykwb pylacrosse pylamarzocco pylast pylaunches pylgnetcast pylibrespot-java pylitejet pylitterbot pylutron-caseta pylutron pymailgunner pymata-express pymediaroom pymeteoclimatic pymicro-vad pymiele pymitv pymochad pymodbus pymonoprice pymsteams pymysensors pynecil pynetgear pynetio pynina pynintendoparental pynobo pynordpool pynuki pynws[retry] pynx584 pynzbgetapi pyobihai pyoctoprintapi pyombi pyopenuv pyopenweathermap pyopnsense pyoppleio-legacy pyosoenergyapi pyotgw pyotp pyoverkiz pypalazzetti pypaperless pypca pypck pypglab pypjlink2 pyplaato pypoint pyportainer pyprobeplus pyprof2calltree pyprosegur pyprusalink pyps4-2ndscreen pyqvrpro pyqwikswitch pyrail pyrainbird pyrate-limiter pyrecswitch pyrepetierng pyrisco pyrituals pyroute2 pyrympro pysabnzbd pysaj pysaunum pyschlage pysensibo pyserial-asyncio-fast pyserial pysesame2 pyseventeentrack pysiaalarm pysignalclirestapi pyskyqhub pysma pysmappee pysmarlaapi pysmartthings pysmarty2 pysmhi pysml pysmlight pysnmp pysnooz pysoma pyspcwebgw pyspeex-noise pysqueezebox pystiebeleltron pysuezV2 pyswitchbee pytautulli pythinkingcleaner python-MotionMount python-awair python-blockchain-api python-bsblan python-citybikes python-clementine-remote python-digitalocean python-ecobee-api python-etherscan-api python-family-hub-local python-fullykiosk python-gc100 python-gitlab python-google-drive-api python-google-weather-api python-homeassistant-analytics python-homewizard-energy python-hpilo python-izone python-join-api python-kasa[speedups] python-linkplay python-matter-server python-melcloud python-miio python-mpd2 python-mystrom python-open-router python-opendata-transport python-opensky python-otbr-api python-overseerr python-picnic-api2 python-pooldose python-rabbitair python-ripple-api python-roborock python-smarttub python-snoo python-songpal python-tado python-technove python-telegram-bot[socks] python-vlc python-xbox pythonegardia pythonkuma pytile pytomorrowio pytouchline_extended pytouchlinesl pytraccar pytradfri[async] pytrafikverket pytrydan pyuptimerobot pyvera pyversasense pyvesync pyvizio pyvlx pyvolumio pywaze pyweatherflowudp pywebpush pywemo pywilight pywizlight pywmspro pyws66i pyxeoma pyyardian pyzbar pyzerproc qbittorrent-api qbusmqttapi qingping-ble qnapstats quantum-gateway radios radiotherm raincloudy rapt-ble raspyrfm-client refoss-ha regenmaschine renault-api renson-endura-delta reolink-aio rfk101py rflink ring-doorbell ritassist rjpl rocketchat-API rokuecp romy roombapy roonapi rova rpi-bad-power russound ruuvitag-ble rxv samsungctl[websocket] samsungtvws[async,encrypted] sanix satel-integra screenlogicpy scsgate securetar sendgrid sense-energy sensirion-ble sensorpro-ble sensorpush-api sensorpush-ble sensorpush-ha sensoterra sentence-stream sentry-sdk sfrbox-api sharkiq sharp_aquos_rc shodan simplefin4py simplehound simplepush simplisafe-python sisyphus-control skyboxremote slack_sdk slixmpp smart-meter-texas snapcast soco solaredge-local solaredge-web solarlog_cli solax somfy-mylink-synergy sonos-websocket speak2mary speedtest-cli spotifyaio sqlparse srpenergy starline starlingbank starlink-grpc-core statsd steamodd stookwijzer streamlabswater subarulink surepy swisshydrodata switchbot-api synology-srm systembridgeconnector tailscale tank-utility tapsaff tellcore-net tellcore-py tellduslive temescal temperusb tesla-fleet-api tesla-powerwall tesla-wall-connector teslemetry-stream tessie-api thermobeacon-ble thermopro-ble thingspeak thinqconnect tikteck tilt-ble tilt-pi tmb todoist-api-python togrill-bluetooth tololib toonapi total-connect-client tp-connected tplink-omada-client transmission-rpc triggercmd ttls ttn_client tuya-device-sharing-sdk twentemilieu twilio twitchAPI typedmonarchmoney uasiren uiprotect ultraheat-api unifi-discovery unifi_ap unifiled universal-silabs-flasher upb-lib upcloud-api url-normalize uvcclient vacuum-map-parser-roborock vallox-websocket-api vegehub vehicle velbus-aio venstarcolortouch victron-ble-ha-parser victron-vrm vilfo-api-client vobject voip-utils volkszaehler volvocarsapi vsure vtjp wakeonlan wallbox watchdog waterfurnace watergate-local-api weatherflow4py webexpythonsdk webio-api webmin-xmlrpc weheat whirlpool-sixth-sense whois wiffi wirelesstagpy wled wolf-comm wsdot wyoming xiaomi-ble xknx xknxproject xmltodict xs1-api-client yalesmartalarmclient yalexs-ble yalexs yeelight yeelightsunflower yolink-api youless-api youtubeaio yt-dlp[default] zabbix-utils zamg zcc-helper zeroconf zeversolar zha zhong-hong-hvac ziggo-mediabox-xl zm-py zwave-js-server-python zwave-me-ws)
          echo "CONTAINER_ID=${CONTAINER_ID}" >> $GITHUB_ENV
          echo "Started container with ID: ${CONTAINER_ID}"

      - name: Export container to tar file
        run: |
          docker export ${CONTAINER_ID} > home-assistant-arm64-slim_${{ env.HA_VERSION }}.tar
          echo "Exported container to home-assistant-arm64-slim_${{ env.HA_VERSION }}.tar"

      - name: Stop and remove container
        run: |
          docker stop ${CONTAINER_ID}
          docker rm ${CONTAINER_ID}
          echo "Stopped and removed container"

      - name: Import tar as new image
        run: |
          docker import home-assistant-arm64-slim_${{ env.HA_VERSION }}.tar home-assistant-arm64-slim:${{ env.HA_VERSION }}
          echo "Imported tar as home-assistant-arm64-slim:${{ env.HA_VERSION }}"

      - name: Get new image size
        run: |
          NEW_SIZE=$(docker images --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}" home-assistant-arm64-slim:${{ env.HA_VERSION }} | tail -n 1 | awk '{print $2}')
          echo "NEW_SIZE=${NEW_SIZE}" >> $GITHUB_ENV
          echo "新镜像大小: ${NEW_SIZE}"

      - name: Calculate size reduction percentage
        run: |
          # Convert sizes to bytes for calculation
          ORIGINAL_SIZE_BYTES=$(echo "${{ env.ORIGINAL_SIZE }}" | sed 's/GB/*1024*1024*1024/g; s/MB/*1024*1024/g; s/KB/*1024/g; s/B//g' | bc)
          NEW_SIZE_BYTES=$(echo "${{ env.NEW_SIZE }}" | sed 's/GB/*1024*1024*1024/g; s/MB/*1024*1024/g; s/KB/*1024/g; s/B//g' | bc)
          
          # Calculate percentage reduction
          REDUCTION=$(echo "scale=2; ((${ORIGINAL_SIZE_BYTES} - ${NEW_SIZE_BYTES}) * 100) / ${ORIGINAL_SIZE_BYTES}" | bc)
          echo "SIZE_REDUCTION=${REDUCTION}%" >> $GITHUB_ENV
          echo "镜像大小减少: ${REDUCTION}%"

      - name: Create builder with docker-container driver
        run: |
          # Create a new builder with docker-container driver
          docker buildx create --use --driver docker-container --name container-builder
          echo "BUILDER_NAME=container-builder" >> $GITHUB_ENV

      - name: Tag and push local image directly
        run: |
          # Convert repository name to lowercase
          REPO_NAME=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')
          
          # Tag the local image for GitHub Container Registry
          docker tag home-assistant-arm64-slim:${{ env.HA_VERSION }} ghcr.io/${REPO_NAME}:${{ env.HA_VERSION }}
          
          # Push the image directly
          docker push ghcr.io/${REPO_NAME}:${{ env.HA_VERSION }}
          echo "Pushed image to GitHub Container Registry"
          echo "镜像已推送到GitHub Container Registry，可以使用以下命令拉取："
          echo "docker pull ghcr.io/${REPO_NAME}:${{ env.HA_VERSION }}"

      - name: Output final message
        run: |
          echo "镜像已推送到GitHub Container Registry，可以使用以下命令拉取："
          echo "docker pull ghcr.io/${{ github.repository }}:${{ env.HA_VERSION }}"