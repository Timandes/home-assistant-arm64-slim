name: Build and Push Home Assistant ARM64 Slim Image

on:
  workflow_dispatch:
    inputs:
      ha_version:
        description: 'Home Assistant version tag (e.g., 2025.12.5)'
        required: true
        default: '2025.12.5'
        type: string

env:
  HA_VERSION: ${{ inputs.ha_version }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=${{ env.HA_VERSION }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Pull original image and get size
        run: |
          docker pull --platform linux/arm64 ghcr.io/home-assistant/home-assistant:${{ env.HA_VERSION }}
          ORIGINAL_SIZE=$(docker images --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}" ghcr.io/home-assistant/home-assistant:${{ env.HA_VERSION }} | tail -n 1 | awk '{print $2}')
          echo "ORIGINAL_SIZE=${ORIGINAL_SIZE}" >> $GITHUB_ENV
          echo "原始镜像大小: ${ORIGINAL_SIZE}"

      - name: Extract original image metadata
        run: |
          # Extract WORKDIR from original image
          ORIGINAL_WORKDIR=$(docker inspect --format='{{.Config.WorkingDir}}' ghcr.io/home-assistant/home-assistant:${{ env.HA_VERSION }})
          echo "ORIGINAL_WORKDIR=${ORIGINAL_WORKDIR}" >> $GITHUB_ENV
          echo "原始 WORKDIR: ${ORIGINAL_WORKDIR}"
          
          # Extract ENTRYPOINT from original image
          ORIGINAL_ENTRYPOINT=$(docker inspect --format='{{json .Config.Entrypoint}}' ghcr.io/home-assistant/home-assistant:${{ env.HA_VERSION }})
          echo "ORIGINAL_ENTRYPOINT=${ORIGINAL_ENTRYPOINT}" >> $GITHUB_ENV
          echo "原始 ENTRYPOINT: ${ORIGINAL_ENTRYPOINT}"

      - name: Create uninstall script
        run: |
          cat > uninstall.sh << 'EOF'
          #!/bin/bash
          uv pip uninstall AEMET-OpenData
          uv pip uninstall AIOSomecomfort
          uv pip uninstall Adax-local
          uv pip uninstall DoorBirdPy
          uv pip uninstall HAP-python
          uv pip uninstall HATasmota
          uv pip uninstall HueBLE
          uv pip uninstall Mastodon.py
          uv pip uninstall PSNAWP
          uv pip uninstall Pillow
          uv pip uninstall PlexAPI
          uv pip uninstall ProgettiHWSW
          uv pip uninstall PyChromecast
          uv pip uninstall PyFlume
          uv pip uninstall PyFronius
          uv pip uninstall PyLoadAPI
          uv pip uninstall PyMetEireann
          uv pip uninstall PyMetno
          uv pip uninstall PyMicroBot
          uv pip uninstall PyNaCl
          uv pip uninstall PyQRCode
          uv pip uninstall PyRMVtransport
          uv pip uninstall PySrDaliGateway
          uv pip uninstall PySwitchbot
          uv pip uninstall PySwitchmate
          uv pip uninstall PySyncThru
          uv pip uninstall PyTransportNSW
          uv pip uninstall PyTurboJPEG
          uv pip uninstall PyViCare
          uv pip uninstall PyXiaomiGateway
          uv pip uninstall RachioPy
          uv pip uninstall RestrictedPython
          uv pip uninstall RtmAPI
          uv pip uninstall SQLAlchemy
          uv pip uninstall Tami4EdgeAPI
          uv pip uninstall TravisPy
          uv pip uninstall TwitterAPI
          uv pip uninstall WSDiscovery
          uv pip uninstall accuweather
          uv pip uninstall actron-neo-api
          uv pip uninstall adax
          uv pip uninstall adb-shell[async]
          uv pip uninstall adext
          uv pip uninstall adguardhome
          uv pip uninstall advantage-air
          uv pip uninstall afsapi
          uv pip uninstall agent-py
          uv pip uninstall aio-geojson-generic-client
          uv pip uninstall aio-geojson-geonetnz-quakes
          uv pip uninstall aio-geojson-geonetnz-volcano
          uv pip uninstall aio-geojson-nsw-rfs-incidents
          uv pip uninstall aio-geojson-usgs-earthquakes
          uv pip uninstall aio-georss-gdacs
          uv pip uninstall aio-ownet
          uv pip uninstall aioacaia
          uv pip uninstall aioairq
          uv pip uninstall aioairzone-cloud
          uv pip uninstall aioairzone
          uv pip uninstall aioamazondevices
          uv pip uninstall aioambient
          uv pip uninstall aioapcaccess
          uv pip uninstall aioaquacell
          uv pip uninstall aioaseko
          uv pip uninstall aioasuswrt
          uv pip uninstall aioautomower
          uv pip uninstall aioazuredevops
          uv pip uninstall aiobafi6
          uv pip uninstall aiobotocore
          uv pip uninstall aiocomelit
          uv pip uninstall aiodhcpwatcher
          uv pip uninstall aiodiscover
          uv pip uninstall aiodns
          uv pip uninstall aiodukeenergy
          uv pip uninstall aioeafm
          uv pip uninstall aioeagle
          uv pip uninstall aioecowitt
          uv pip uninstall aioelectricitymaps
          uv pip uninstall aioemonitor
          uv pip uninstall aioesphomeapi
          uv pip uninstall aiofiles
          uv pip uninstall aioflo
          uv pip uninstall aioftp
          uv pip uninstall aiogithubapi
          uv pip uninstall aioguardian
          uv pip uninstall aioharmony
          uv pip uninstall aiohasupervisor
          uv pip uninstall aiohomeconnect
          uv pip uninstall aiohomekit
          uv pip uninstall aiohttp_sse
          uv pip uninstall aiohue
          uv pip uninstall aioimaplib
          uv pip uninstall aioimmich
          uv pip uninstall aiokafka
          uv pip uninstall aiokef
          uv pip uninstall aiokem
          uv pip uninstall aiolifx-effects
          uv pip uninstall aiolifx-themes
          uv pip uninstall aiolifx
          uv pip uninstall aiolookin
          uv pip uninstall aiolyric
          uv pip uninstall aiomealie
          uv pip uninstall aiomodernforms
          uv pip uninstall aiomusiccast
          uv pip uninstall aionanoleaf
          uv pip uninstall aionotion
          uv pip uninstall aiontfy
          uv pip uninstall aionut
          uv pip uninstall aioonkyo
          uv pip uninstall aioopenexchangerates
          uv pip uninstall aiooui
          uv pip uninstall aiopegelonline
          uv pip uninstall aiopulse
          uv pip uninstall aiopurpleair
          uv pip uninstall aiopvapi
          uv pip uninstall aiopvpc
          uv pip uninstall aiopyarr
          uv pip uninstall aioqsw
          uv pip uninstall aioraven
          uv pip uninstall aiorecollect
          uv pip uninstall aioridwell
          uv pip uninstall aioruckus
          uv pip uninstall aiorussound
          uv pip uninstall aioruuvigateway
          uv pip uninstall aiosenz
          uv pip uninstall aioshelly
          uv pip uninstall aioskybell
          uv pip uninstall aioslimproto
          uv pip uninstall aiosolaredge
          uv pip uninstall aiosteamist
          uv pip uninstall aiostreammagic
          uv pip uninstall aioswitcher
          uv pip uninstall aiosyncthing
          uv pip uninstall aiotankerkoenig
          uv pip uninstall aiotedee
          uv pip uninstall aiotractive
          uv pip uninstall aiounifi
          uv pip uninstall aiousbwatcher
          uv pip uninstall aiovlc
          uv pip uninstall aiovodafone
          uv pip uninstall aiowaqi
          uv pip uninstall aiowatttime
          uv pip uninstall aiowebdav2
          uv pip uninstall aiowebostv
          uv pip uninstall aiowithings
          uv pip uninstall aioymaps
          uv pip uninstall airgradient
          uv pip uninstall airly
          uv pip uninstall airos
          uv pip uninstall airthings-ble
          uv pip uninstall airthings-cloud
          uv pip uninstall airtouch4pyapi
          uv pip uninstall airtouch5py
          uv pip uninstall alpha-vantage
          uv pip uninstall altruistclient
          uv pip uninstall amberelectric
          uv pip uninstall amcrest
          uv pip uninstall androidtv[async]
          uv pip uninstall androidtvremote2
          uv pip uninstall anel-pwrctrl-homeassistant
          uv pip uninstall anova-wifi
          uv pip uninstall anthemav
          uv pip uninstall anthropic
          uv pip uninstall anyio
          uv pip uninstall apple_weatherkit
          uv pip uninstall apprise
          uv pip uninstall aprslib
          uv pip uninstall apsystems-ez1
          uv pip uninstall aqualogic
          uv pip uninstall aranet4
          uv pip uninstall arcam-fmj
          uv pip uninstall arris-tg2492lg
          uv pip uninstall asmog
          uv pip uninstall asusrouter
          uv pip uninstall async-upnp-client
          uv pip uninstall asyncarve
          uv pip uninstall asyncinotify
          uv pip uninstall asyncpysupla
          uv pip uninstall asyncsleepiq
          uv pip uninstall asyncssh
          uv pip uninstall auroranoaa
          uv pip uninstall aurorapy
          uv pip uninstall autarco
          uv pip uninstall automower-ble
          uv pip uninstall av
          uv pip uninstall avea
          uv pip uninstall axis
          uv pip uninstall ayla-iot-unofficial
          uv pip uninstall azure-eventhub
          uv pip uninstall azure-kusto-data[aio]
          uv pip uninstall azure-kusto-ingest
          uv pip uninstall azure-servicebus
          uv pip uninstall azure-storage-blob
          uv pip uninstall b2sdk
          uv pip uninstall babel
          uv pip uninstall baidu-aip
          uv pip uninstall base36
          uv pip uninstall batinfo
          uv pip uninstall beautifulsoup4
          uv pip uninstall bimmer-connected[china]
          uv pip uninstall bizkaibus
          uv pip uninstall bleak-esphome
          uv pip uninstall bleak-retry-connector
          uv pip uninstall bleak
          uv pip uninstall blebox-uniapi
          uv pip uninstall blinkpy
          uv pip uninstall blockchain
          uv pip uninstall bluecurrent-api
          uv pip uninstall bluemaestro-ble
          uv pip uninstall bluetooth-adapters
          uv pip uninstall bluetooth-auto-recovery
          uv pip uninstall bluetooth-data-tools
          uv pip uninstall bond-async
          uv pip uninstall bosch-alarm-mode2
          uv pip uninstall boschshcpy
          uv pip uninstall boto3
          uv pip uninstall botocore
          uv pip uninstall bring-api
          uv pip uninstall broadlink
          uv pip uninstall brother
          uv pip uninstall brottsplatskartan
          uv pip uninstall brunt
          uv pip uninstall bthome-ble
          uv pip uninstall bthomehub5-devicelist
          uv pip uninstall btsmarthub-devicelist
          uv pip uninstall buienradar
          uv pip uninstall cached-ipaddress
          uv pip uninstall caldav
          uv pip uninstall ciscomobilityexpress
          uv pip uninstall clearpasspy
          uv pip uninstall clx-sdk-xms
          uv pip uninstall coinbase-advanced-py
          uv pip uninstall colorlog
          uv pip uninstall colorthief
          uv pip uninstall compit-inext-api
          uv pip uninstall concord232
          uv pip uninstall connect-box
          uv pip uninstall construct
          uv pip uninstall cookidoo-api
          uv pip uninstall cronsim
          uv pip uninstall crownstone-cloud
          uv pip uninstall crownstone-sse
          uv pip uninstall crownstone-uart
          uv pip uninstall datadog
          uv pip uninstall datapoint
          uv pip uninstall dbus-fast
          uv pip uninstall debugpy
          uv pip uninstall decora-wifi
          uv pip uninstall deebot-client
          uv pip uninstall defusedxml
          uv pip uninstall deluge-client
          uv pip uninstall demetriek
          uv pip uninstall denonavr
          uv pip uninstall devialet
          uv pip uninstall devolo-home-control-api
          uv pip uninstall devolo-plc-api
          uv pip uninstall dio-chacon-wifi-api
          uv pip uninstall directv
          uv pip uninstall discogs-client
          uv pip uninstall discovery30303
          uv pip uninstall dremel3dpy
          uv pip uninstall dropmqttapi
          uv pip uninstall dsmr-parser
          uv pip uninstall dwdwfsapi
          uv pip uninstall dynalite-devices
          uv pip uninstall dynalite-panel
          uv pip uninstall eagle100
          uv pip uninstall easyenergy
          uv pip uninstall ebusdpy
          uv pip uninstall ecoaliface
          uv pip uninstall eheimdigital
          uv pip uninstall ekey-bionyxpy
          uv pip uninstall electrickiwi-api
          uv pip uninstall elevenlabs
          uv pip uninstall elgato
          uv pip uninstall eliqonline
          uv pip uninstall elkm1-lib
          uv pip uninstall elkoep-aio-mqtt
          uv pip uninstall elmax-api
          uv pip uninstall elvia
          uv pip uninstall emoji
          uv pip uninstall emulated-roku
          uv pip uninstall energyflip-client
          uv pip uninstall energyid-webhooks
          uv pip uninstall energyzero
          uv pip uninstall enocean
          uv pip uninstall enturclient
          uv pip uninstall env-canada
          uv pip uninstall ephem
          uv pip uninstall epicstore-api
          uv pip uninstall epion
          uv pip uninstall epson-projector
          uv pip uninstall eq3btsmart
          uv pip uninstall esphome-dashboard-api
          uv pip uninstall essent-dynamic-pricing
          uv pip uninstall eternalegypt
          uv pip uninstall eufylife-ble-client
          uv pip uninstall evohome-async
          uv pip uninstall evolutionhttp
          uv pip uninstall faadelays
          uv pip uninstall fastdotcom
          uv pip uninstall feedparser
          uv pip uninstall file-read-backwards
          uv pip uninstall fing_agent_api
          uv pip uninstall fints
          uv pip uninstall fitbit-web-api
          uv pip uninstall fitbit
          uv pip uninstall fivem-api
          uv pip uninstall fixerio
          uv pip uninstall fjaraskupan
          uv pip uninstall flexit_bacnet
          uv pip uninstall flipr-api
          uv pip uninstall flux-led
          uv pip uninstall fnv-hash-fast
          uv pip uninstall foobot_async
          uv pip uninstall forecast-solar
          uv pip uninstall fortiosapi
          uv pip uninstall freebox-api
          uv pip uninstall freesms
          uv pip uninstall fressnapftracker
          uv pip uninstall fritzconnection[qr]
          uv pip uninstall fyta_cli
          uv pip uninstall gTTS
          uv pip uninstall gardena-bluetooth
          uv pip uninstall gassist-text
          uv pip uninstall gcal-sync
          uv pip uninstall genie-partner-sdk
          uv pip uninstall geniushub-client
          uv pip uninstall geocachingapi
          uv pip uninstall geopy
          uv pip uninstall georss-generic-client
          uv pip uninstall georss-ign-sismologia-client
          uv pip uninstall georss-qld-bushfire-alert-client
          uv pip uninstall getmac
          uv pip uninstall gios
          uv pip uninstall gitterpy
          uv pip uninstall glances-api
          uv pip uninstall go2rtc-client
          uv pip uninstall goalzero
          uv pip uninstall goodwe
          uv pip uninstall google-api-python-client
          uv pip uninstall google-cloud-pubsub
          uv pip uninstall google-cloud-speech
          uv pip uninstall google-cloud-texttospeech
          uv pip uninstall google-genai
          uv pip uninstall google-maps-routing
          uv pip uninstall google-nest-sdm
          uv pip uninstall google-photos-library-api
          uv pip uninstall google_air_quality_api
          uv pip uninstall goslide-api
          uv pip uninstall gotailwind
          uv pip uninstall govee-ble
          uv pip uninstall govee-local-api
          uv pip uninstall gpiozero
          uv pip uninstall gps3
          uv pip uninstall greeclimate
          uv pip uninstall greeneye_monitor
          uv pip uninstall greenwavereality
          uv pip uninstall gridnet
          uv pip uninstall growattServer
          uv pip uninstall gspread
          uv pip uninstall guppy3
          uv pip uninstall h2
          uv pip uninstall ha-ffmpeg
          uv pip uninstall ha-iotawattpy
          uv pip uninstall ha-philipsjs
          uv pip uninstall ha-silabs-firmware-client
          uv pip uninstall habiticalib
          uv pip uninstall habluetooth
          uv pip uninstall hanna-cloud
          uv pip uninstall hass-nabucasa
          uv pip uninstall hass-splunk
          uv pip uninstall hassil
          uv pip uninstall hdate[astral]
          uv pip uninstall heatmiserV3
          uv pip uninstall here-routing
          uv pip uninstall here-transit
          uv pip uninstall hikvision
          uv pip uninstall hkavr
          uv pip uninstall hko
          uv pip uninstall hlk-sw16
          uv pip uninstall hole
          uv pip uninstall holidays
          uv pip uninstall home-assistant-frontend
          uv pip uninstall home-assistant-intents
          uv pip uninstall homelink-integration-api
          uv pip uninstall homematicip
          uv pip uninstall horimote
          uv pip uninstall httplib2
          uv pip uninstall huawei-lte-api
          uv pip uninstall huum
          uv pip uninstall hyperion-py
          uv pip uninstall iammeter
          uv pip uninstall iaqualink
          uv pip uninstall ibeacon-ble
          uv pip uninstall ical
          uv pip uninstall icalendar
          uv pip uninstall icmplib
          uv pip uninstall idasen-ha
          uv pip uninstall ifaddr
          uv pip uninstall iglo
          uv pip uninstall igloohome-api
          uv pip uninstall ihcsdk
          uv pip uninstall imeon_inverter_api
          uv pip uninstall imgw_pib
          uv pip uninstall incomfort-client
          uv pip uninstall influxdb-client
          uv pip uninstall influxdb
          uv pip uninstall inkbird-ble
          uv pip uninstall insteon-frontend-home-assistant
          uv pip uninstall intellifire4py
          uv pip uninstall iometer
          uv pip uninstall iottycloud
          uv pip uninstall iperf3
          uv pip uninstall irm-kmi-api
          uv pip uninstall isal
          uv pip uninstall ismartgate
          uv pip uninstall israel-rail-api
          uv pip uninstall jaraco.abode
          uv pip uninstall jellyfin-apiclient-python
          uv pip uninstall jsonpath
          uv pip uninstall justnimbus
          uv pip uninstall kaiterra-async-client
          uv pip uninstall keba-kecontact
          uv pip uninstall kegtron-ble
          uv pip uninstall kiwiki-client
          uv pip uninstall knocki
          uv pip uninstall knx-frontend
          uv pip uninstall konnected
          uv pip uninstall krakenex
          uv pip uninstall lacrosse-view
          uv pip uninstall lakeside
          uv pip uninstall laundrify-aio
          uv pip uninstall lcn-frontend
          uv pip uninstall ld2410-ble
          uv pip uninstall leaone-ble
          uv pip uninstall led-ble
          uv pip uninstall lektricowifi
          uv pip uninstall letpot
          uv pip uninstall libpyfoscamcgi
          uv pip uninstall libpyvivotek
          uv pip uninstall librehardwaremonitor-api
          uv pip uninstall librouteros
          uv pip uninstall libsoundtouch
          uv pip uninstall lightify
          uv pip uninstall lightwave
          uv pip uninstall limitlessled
          uv pip uninstall linode-api
          uv pip uninstall livisi
          uv pip uninstall locationsharinglib
          uv pip uninstall london-tube-status
          uv pip uninstall loqedAPI
          uv pip uninstall luftdaten
          uv pip uninstall lunatone-rest-api-client
          uv pip uninstall lupupy
          uv pip uninstall lw12
          uv pip uninstall lxml
          uv pip uninstall matrix-nio
          uv pip uninstall maxcube-api
          uv pip uninstall mbddns
          uv pip uninstall mcp
          uv pip uninstall mcstatus
          uv pip uninstall meater-python
          uv pip uninstall medcom-ble
          uv pip uninstall melnor-bluetooth
          uv pip uninstall messagebird
          uv pip uninstall meteo-lt-pkg
          uv pip uninstall meteoalertapi
          uv pip uninstall meteofrance-api
          uv pip uninstall mficlient
          uv pip uninstall micloud
          uv pip uninstall microBeesPy
          uv pip uninstall mill-local
          uv pip uninstall millheater
          uv pip uninstall minio
          uv pip uninstall moat-ble
          uv pip uninstall moehlenhoff-alpha2
          uv pip uninstall momonga
          uv pip uninstall monzopy
          uv pip uninstall mopeka-iot-ble
          uv pip uninstall motionblinds
          uv pip uninstall motionblindsble
          uv pip uninstall motioneye-client
          uv pip uninstall mozart-api
          uv pip uninstall mullvad-api
          uv pip uninstall music-assistant-client
          uv pip uninstall mutagen
          uv pip uninstall mutesync
          uv pip uninstall mvg
          uv pip uninstall mypermobil
          uv pip uninstall myuplink
          uv pip uninstall nad-receiver
          uv pip uninstall ndms2-client
          uv pip uninstall nessclient
          uv pip uninstall netdata
          uv pip uninstall netmap
          uv pip uninstall nettigo-air-monitor
          uv pip uninstall neurio
          uv pip uninstall nexia
          uv pip uninstall nextcloudmonitor
          uv pip uninstall nextcord
          uv pip uninstall nextdns
          uv pip uninstall nhc
          uv pip uninstall nibe
          uv pip uninstall nice-go
          uv pip uninstall niluclient
          uv pip uninstall noaa-coops
          uv pip uninstall notifications-android-tv
          uv pip uninstall notify-events
          uv pip uninstall nsapi
          uv pip uninstall nsw-fuel-api-client
          uv pip uninstall nuheat
          uv pip uninstall numato-gpio
          uv pip uninstall numpy
          uv pip uninstall nyt_games
          uv pip uninstall oasatelematics
          uv pip uninstall oauth2client
          uv pip uninstall objgraph
          uv pip uninstall odp-amsterdam
          uv pip uninstall oemthermostat
          uv pip uninstall ohme
          uv pip uninstall ollama
          uv pip uninstall omnilogic
          uv pip uninstall ondilo
          uv pip uninstall onedrive-personal-sdk
          uv pip uninstall onvif-zeep-async
          uv pip uninstall open-garage
          uv pip uninstall open-meteo
          uv pip uninstall openai
          uv pip uninstall openerz-api
          uv pip uninstall openevsewifi
          uv pip uninstall openhomedevice
          uv pip uninstall openrgb-python
          uv pip uninstall opensensemap-api
          uv pip uninstall openwebifpy
          uv pip uninstall openwrt-luci-rpc
          uv pip uninstall openwrt-ubus-rpc
          uv pip uninstall opower
          uv pip uninstall oralb-ble
          uv pip uninstall oru
          uv pip uninstall orvibo
          uv pip uninstall ourgroceries
          uv pip uninstall ovoenergy
          uv pip uninstall p1monitor
          uv pip uninstall paho-mqtt
          uv pip uninstall panacotta
          uv pip uninstall panasonic-viera
          uv pip uninstall pdunehd
          uv pip uninstall peblar
          uv pip uninstall peco
          uv pip uninstall pencompy
          uv pip uninstall pescea
          uv pip uninstall pexpect
          uv pip uninstall phone-modem
          uv pip uninstall pigpio
          uv pip uninstall pilight
          uv pip uninstall plexauth
          uv pip uninstall plexwebsocket
          uv pip uninstall plugwise
          uv pip uninstall pmsensor
          uv pip uninstall poolsense
          uv pip uninstall powerfox
          uv pip uninstall praw
          uv pip uninstall prayer-times-calculator-offline
          uv pip uninstall proliphix
          uv pip uninstall prometheus-client
          uv pip uninstall prowlpy
          uv pip uninstall proxmoxer
          uv pip uninstall psutil-home-assistant
          uv pip uninstall psutil
          uv pip uninstall pulsectl
          uv pip uninstall pushbullet.py
          uv pip uninstall pushover_complete
          uv pip uninstall pvo
          uv pip uninstall py-aosmith
          uv pip uninstall py-canary
          uv pip uninstall py-cpuinfo
          uv pip uninstall py-dactyl
          uv pip uninstall py-dormakaba-dkey
          uv pip uninstall py-improv-ble-client
          uv pip uninstall py-madvr2
          uv pip uninstall py-melissa-climate
          uv pip uninstall py-nextbusnext
          uv pip uninstall py-nightscout
          uv pip uninstall py-schluter
          uv pip uninstall py-sucks
          uv pip uninstall py-synologydsm-api
          uv pip uninstall pyAtome
          uv pip uninstall pyCEC
          uv pip uninstall pyControl4
          uv pip uninstall pyDuotecno
          uv pip uninstall pyElectra
          uv pip uninstall pyEmby
          uv pip uninstall pyHik
          uv pip uninstall pyHomee
          uv pip uninstall pyRFXtrx
          uv pip uninstall pySDCP
          uv pip uninstall pyTibber
          uv pip uninstall pyW215
          uv pip uninstall pyW800rf32
          uv pip uninstall py_ccm15
          uv pip uninstall pyads
          uv pip uninstall pyaehw4a1
          uv pip uninstall pyaftership
          uv pip uninstall pyairnow
          uv pip uninstall pyairobotrest
          uv pip uninstall pyairvisual
          uv pip uninstall pyanglianwater
          uv pip uninstall pyaprilaire
          uv pip uninstall pyatag
          uv pip uninstall pyatmo
          uv pip uninstall pyatv
          uv pip uninstall pyaussiebb
          uv pip uninstall pybalboa
          uv pip uninstall pybbox
          uv pip uninstall pyblackbird
          uv pip uninstall pyblu
          uv pip uninstall pybotvac
          uv pip uninstall pybravia
          uv pip uninstall pycarwings2
          uv pip uninstall pycfdns
          uv pip uninstall pychannels
          uv pip uninstall pycketcasts
          uv pip uninstall pycmus
          uv pip uninstall pycomfoconnect
          uv pip uninstall pycoolmasternet-async
          uv pip uninstall pycountry
          uv pip uninstall pycsspeechtts
          uv pip uninstall pycync
          uv pip uninstall pydaikin
          uv pip uninstall pydanfossair
          uv pip uninstall pydeako
          uv pip uninstall pydeconz
          uv pip uninstall pydelijn
          uv pip uninstall pydexcom
          uv pip uninstall pydiscovergy
          uv pip uninstall pydoods
          uv pip uninstall pydrawise
          uv pip uninstall pydroid-ipcam
          uv pip uninstall pydroplet
          uv pip uninstall pyebox
          uv pip uninstall pyecoforest
          uv pip uninstall pyeconet
          uv pip uninstall pyecotrend-ista
          uv pip uninstall pyedimax
          uv pip uninstall pyefergy
          uv pip uninstall pyegps
          uv pip uninstall pyemoncms
          uv pip uninstall pyenphase
          uv pip uninstall pyenvisalink
          uv pip uninstall pyephember2
          uv pip uninstall pyeverlights
          uv pip uninstall pyevilgenius
          uv pip uninstall pyezvizapi
          uv pip uninstall pyfibaro
          uv pip uninstall pyfido
          uv pip uninstall pyfirefly
          uv pip uninstall pyfireservicerota
          uv pip uninstall pyflic
          uv pip uninstall pyfnip
          uv pip uninstall pyforked-daapd
          uv pip uninstall pyfreedompro
          uv pip uninstall pyfritzhome
          uv pip uninstall pyfttt
          uv pip uninstall pygatt[GATTTOOL]
          uv pip uninstall pygtfs
          uv pip uninstall pygti
          uv pip uninstall pyhaversion
          uv pip uninstall pyheos
          uv pip uninstall pyhive-integration
          uv pip uninstall pyhomematic
          uv pip uninstall pyhomeworks
          uv pip uninstall pyialarm
          uv pip uninstall pyicloud
          uv pip uninstall pyinsteon
          uv pip uninstall pyintesishome
          uv pip uninstall pyipma
          uv pip uninstall pyipp
          uv pip uninstall pyiqvia
          uv pip uninstall pyirishrail
          uv pip uninstall pyiskra
          uv pip uninstall pyiss
          uv pip uninstall pyisy
          uv pip uninstall pyitachip2ir
          uv pip uninstall pyituran
          uv pip uninstall pyjvcprojector
          uv pip uninstall pykaleidescape
          uv pip uninstall pykira
          uv pip uninstall pykmtronic
          uv pip uninstall pykodi
          uv pip uninstall pykoplenti
          uv pip uninstall pykrakenapi
          uv pip uninstall pykulersky
          uv pip uninstall pykwb
          uv pip uninstall pylacrosse
          uv pip uninstall pylamarzocco
          uv pip uninstall pylast
          uv pip uninstall pylaunches
          uv pip uninstall pylgnetcast
          uv pip uninstall pylibrespot-java
          uv pip uninstall pylitejet
          uv pip uninstall pylitterbot
          uv pip uninstall pylutron-caseta
          uv pip uninstall pylutron
          uv pip uninstall pymailgunner
          uv pip uninstall pymata-express
          uv pip uninstall pymediaroom
          uv pip uninstall pymeteoclimatic
          uv pip uninstall pymicro-vad
          uv pip uninstall pymiele
          uv pip uninstall pymitv
          uv pip uninstall pymochad
          uv pip uninstall pymodbus
          uv pip uninstall pymonoprice
          uv pip uninstall pymsteams
          uv pip uninstall pymysensors
          uv pip uninstall pynecil
          uv pip uninstall pynetgear
          uv pip uninstall pynetio
          uv pip uninstall pynina
          uv pip uninstall pynintendoparental
          uv pip uninstall pynobo
          uv pip uninstall pynordpool
          uv pip uninstall pynuki
          uv pip uninstall pynws[retry]
          uv pip uninstall pynx584
          uv pip uninstall pynzbgetapi
          uv pip uninstall pyobihai
          uv pip uninstall pyoctoprintapi
          uv pip uninstall pyombi
          uv pip uninstall pyopenuv
          uv pip uninstall pyopenweathermap
          uv pip uninstall pyopnsense
          uv pip uninstall pyoppleio-legacy
          uv pip uninstall pyosoenergyapi
          uv pip uninstall pyotgw
          uv pip uninstall pyotp
          uv pip uninstall pyoverkiz
          uv pip uninstall pypalazzetti
          uv pip uninstall pypaperless
          uv pip uninstall pypca
          uv pip uninstall pypck
          uv pip uninstall pypglab
          uv pip uninstall pypjlink2
          uv pip uninstall pyplaato
          uv pip uninstall pypoint
          uv pip uninstall pyportainer
          uv pip uninstall pyprobeplus
          uv pip uninstall pyprof2calltree
          uv pip uninstall pyprosegur
          uv pip uninstall pyprusalink
          uv pip uninstall pyps4-2ndscreen
          uv pip uninstall pyqvrpro
          uv pip uninstall pyqwikswitch
          uv pip uninstall pyrail
          uv pip uninstall pyrainbird
          uv pip uninstall pyrate-limiter
          uv pip uninstall pyrecswitch
          uv pip uninstall pyrepetierng
          uv pip uninstall pyrisco
          uv pip uninstall pyrituals
          uv pip uninstall pyroute2
          uv pip uninstall pyrympro
          uv pip uninstall pysabnzbd
          uv pip uninstall pysaj
          uv pip uninstall pysaunum
          uv pip uninstall pyschlage
          uv pip uninstall pysensibo
          uv pip uninstall pyserial-asyncio-fast
          uv pip uninstall pyserial
          uv pip uninstall pysesame2
          uv pip uninstall pyseventeentrack
          uv pip uninstall pysiaalarm
          uv pip uninstall pysignalclirestapi
          uv pip uninstall pyskyqhub
          uv pip uninstall pysma
          uv pip uninstall pysmappee
          uv pip uninstall pysmarlaapi
          uv pip uninstall pysmartthings
          uv pip uninstall pysmarty2
          uv pip uninstall pysmhi
          uv pip uninstall pysml
          uv pip uninstall pysmlight
          uv pip uninstall pysnmp
          uv pip uninstall pysnooz
          uv pip uninstall pysoma
          uv pip uninstall pyspcwebgw
          uv pip uninstall pyspeex-noise
          uv pip uninstall pysqueezebox
          uv pip uninstall pystiebeleltron
          uv pip uninstall pysuezV2
          uv pip uninstall pyswitchbee
          uv pip uninstall pytautulli
          uv pip uninstall pythinkingcleaner
          uv pip uninstall python-MotionMount
          uv pip uninstall python-awair
          uv pip uninstall python-blockchain-api
          uv pip uninstall python-bsblan
          uv pip uninstall python-citybikes
          uv pip uninstall python-clementine-remote
          uv pip uninstall python-digitalocean
          uv pip uninstall python-ecobee-api
          uv pip uninstall python-etherscan-api
          uv pip uninstall python-family-hub-local
          uv pip uninstall python-fullykiosk
          uv pip uninstall python-gc100
          uv pip uninstall python-gitlab
          uv pip uninstall python-google-drive-api
          uv pip uninstall python-google-weather-api
          uv pip uninstall python-homeassistant-analytics
          uv pip uninstall python-homewizard-energy
          uv pip uninstall python-hpilo
          uv pip uninstall python-izone
          uv pip uninstall python-join-api
          uv pip uninstall python-kasa[speedups]
          uv pip uninstall python-linkplay
          uv pip uninstall python-matter-server
          uv pip uninstall python-melcloud
          uv pip uninstall python-miio
          uv pip uninstall python-mpd2
          uv pip uninstall python-mystrom
          uv pip uninstall python-open-router
          uv pip uninstall python-opendata-transport
          uv pip uninstall python-opensky
          uv pip uninstall python-otbr-api
          uv pip uninstall python-overseerr
          uv pip uninstall python-picnic-api2
          uv pip uninstall python-pooldose
          uv pip uninstall python-rabbitair
          uv pip uninstall python-ripple-api
          uv pip uninstall python-roborock
          uv pip uninstall python-smarttub
          uv pip uninstall python-snoo
          uv pip uninstall python-songpal
          uv pip uninstall python-tado
          uv pip uninstall python-technove
          uv pip uninstall python-telegram-bot[socks]
          uv pip uninstall python-vlc
          uv pip uninstall python-xbox
          uv pip uninstall pythonegardia
          uv pip uninstall pythonkuma
          uv pip uninstall pytile
          uv pip uninstall pytomorrowio
          uv pip uninstall pytouchline_extended
          uv pip uninstall pytouchlinesl
          uv pip uninstall pytraccar
          uv pip uninstall pytradfri[async]
          uv pip uninstall pytrafikverket
          uv pip uninstall pytrydan
          uv pip uninstall pyuptimerobot
          uv pip uninstall pyvera
          uv pip uninstall pyversasense
          uv pip uninstall pyvesync
          uv pip uninstall pyvizio
          uv pip uninstall pyvlx
          uv pip uninstall pyvolumio
          uv pip uninstall pywaze
          uv pip uninstall pyweatherflowudp
          uv pip uninstall pywebpush
          uv pip uninstall pywemo
          uv pip uninstall pywilight
          uv pip uninstall pywizlight
          uv pip uninstall pywmspro
          uv pip uninstall pyws66i
          uv pip uninstall pyxeoma
          uv pip uninstall pyyardian
          uv pip uninstall pyzbar
          uv pip uninstall pyzerproc
          uv pip uninstall qbittorrent-api
          uv pip uninstall qbusmqttapi
          uv pip uninstall qingping-ble
          uv pip uninstall qnapstats
          uv pip uninstall quantum-gateway
          uv pip uninstall radios
          uv pip uninstall radiotherm
          uv pip uninstall raincloudy
          uv pip uninstall rapt-ble
          uv pip uninstall raspyrfm-client
          uv pip uninstall refoss-ha
          uv pip uninstall regenmaschine
          uv pip uninstall renault-api
          uv pip uninstall renson-endura-delta
          uv pip uninstall reolink-aio
          uv pip uninstall rfk101py
          uv pip uninstall rflink
          uv pip uninstall ring-doorbell
          uv pip uninstall ritassist
          uv pip uninstall rjpl
          uv pip uninstall rocketchat-API
          uv pip uninstall rokuecp
          uv pip uninstall romy
          uv pip uninstall roombapy
          uv pip uninstall roonapi
          uv pip uninstall rova
          uv pip uninstall rpi-bad-power
          uv pip uninstall russound
          uv pip uninstall ruuvitag-ble
          uv pip uninstall rxv
          uv pip uninstall samsungctl[websocket]
          uv pip uninstall samsungtvws[async,encrypted]
          uv pip uninstall sanix
          uv pip uninstall satel-integra
          uv pip uninstall screenlogicpy
          uv pip uninstall scsgate
          uv pip uninstall securetar
          uv pip uninstall sendgrid
          uv pip uninstall sense-energy
          uv pip uninstall sensirion-ble
          uv pip uninstall sensorpro-ble
          uv pip uninstall sensorpush-api
          uv pip uninstall sensorpush-ble
          uv pip uninstall sensorpush-ha
          uv pip uninstall sensoterra
          uv pip uninstall sentence-stream
          uv pip uninstall sentry-sdk
          uv pip uninstall sfrbox-api
          uv pip uninstall sharkiq
          uv pip uninstall sharp_aquos_rc
          uv pip uninstall shodan
          uv pip uninstall simplefin4py
          uv pip uninstall simplehound
          uv pip uninstall simplepush
          uv pip uninstall simplisafe-python
          uv pip uninstall sisyphus-control
          uv pip uninstall skyboxremote
          uv pip uninstall slack_sdk
          uv pip uninstall slixmpp
          uv pip uninstall smart-meter-texas
          uv pip uninstall snapcast
          uv pip uninstall soco
          uv pip uninstall solaredge-local
          uv pip uninstall solaredge-web
          uv pip uninstall solarlog_cli
          uv pip uninstall solax
          uv pip uninstall somfy-mylink-synergy
          uv pip uninstall sonos-websocket
          uv pip uninstall speak2mary
          uv pip uninstall speedtest-cli
          uv pip uninstall spotifyaio
          uv pip uninstall sqlparse
          uv pip uninstall srpenergy
          uv pip uninstall starline
          uv pip uninstall starlingbank
          uv pip uninstall starlink-grpc-core
          uv pip uninstall statsd
          uv pip uninstall steamodd
          uv pip uninstall stookwijzer
          uv pip uninstall streamlabswater
          uv pip uninstall subarulink
          uv pip uninstall surepy
          uv pip uninstall swisshydrodata
          uv pip uninstall switchbot-api
          uv pip uninstall synology-srm
          uv pip uninstall systembridgeconnector
          uv pip uninstall tailscale
          uv pip uninstall tank-utility
          uv pip uninstall tapsaff
          uv pip uninstall tellcore-net
          uv pip uninstall tellcore-py
          uv pip uninstall tellduslive
          uv pip uninstall temescal
          uv pip uninstall temperusb
          uv pip uninstall tesla-fleet-api
          uv pip uninstall tesla-powerwall
          uv pip uninstall tesla-wall-connector
          uv pip uninstall teslemetry-stream
          uv pip uninstall tessie-api
          uv pip uninstall thermobeacon-ble
          uv pip uninstall thermopro-ble
          uv pip uninstall thingspeak
          uv pip uninstall thinqconnect
          uv pip uninstall tikteck
          uv pip uninstall tilt-ble
          uv pip uninstall tilt-pi
          uv pip uninstall tmb
          uv pip uninstall todoist-api-python
          uv pip uninstall togrill-bluetooth
          uv pip uninstall tololib
          uv pip uninstall toonapi
          uv pip uninstall total-connect-client
          uv pip uninstall tp-connected
          uv pip uninstall tplink-omada-client
          uv pip uninstall transmission-rpc
          uv pip uninstall triggercmd
          uv pip uninstall ttls
          uv pip uninstall ttn_client
          uv pip uninstall tuya-device-sharing-sdk
          uv pip uninstall twentemilieu
          uv pip uninstall twilio
          uv pip uninstall twitchAPI
          uv pip uninstall typedmonarchmoney
          uv pip uninstall uasiren
          uv pip uninstall uiprotect
          uv pip uninstall ultraheat-api
          uv pip uninstall unifi-discovery
          uv pip uninstall unifi_ap
          uv pip uninstall unifiled
          uv pip uninstall universal-silabs-flasher
          uv pip uninstall upb-lib
          uv pip uninstall upcloud-api
          uv pip uninstall url-normalize
          uv pip uninstall uvcclient
          uv pip uninstall vacuum-map-parser-roborock
          uv pip uninstall vallox-websocket-api
          uv pip uninstall vegehub
          uv pip uninstall vehicle
          uv pip uninstall velbus-aio
          uv pip uninstall venstarcolortouch
          uv pip uninstall victron-ble-ha-parser
          uv pip uninstall victron-vrm
          uv pip uninstall vilfo-api-client
          uv pip uninstall vobject
          uv pip uninstall voip-utils
          uv pip uninstall volkszaehler
          uv pip uninstall volvocarsapi
          uv pip uninstall vsure
          uv pip uninstall vtjp
          uv pip uninstall wakeonlan
          uv pip uninstall wallbox
          uv pip uninstall watchdog
          uv pip uninstall waterfurnace
          uv pip uninstall watergate-local-api
          uv pip uninstall weatherflow4py
          uv pip uninstall webexpythonsdk
          uv pip uninstall webio-api
          uv pip uninstall webmin-xmlrpc
          uv pip uninstall weheat
          uv pip uninstall whirlpool-sixth-sense
          uv pip uninstall whois
          uv pip uninstall wiffi
          uv pip uninstall wirelesstagpy
          uv pip uninstall wled
          uv pip uninstall wolf-comm
          uv pip uninstall wsdot
          uv pip uninstall wyoming
          uv pip uninstall xiaomi-ble
          uv pip uninstall xknx
          uv pip uninstall xknxproject
          uv pip uninstall xmltodict
          uv pip uninstall xs1-api-client
          uv pip uninstall yalesmartalarmclient
          uv pip uninstall yalexs-ble
          uv pip uninstall yalexs
          uv pip uninstall yeelight
          uv pip uninstall yeelightsunflower
          uv pip uninstall yolink-api
          uv pip uninstall youless-api
          uv pip uninstall youtubeaio
          uv pip uninstall yt-dlp[default]
          uv pip uninstall zabbix-utils
          uv pip uninstall zamg
          uv pip uninstall zcc-helper
          uv pip uninstall zeroconf
          uv pip uninstall zeversolar
          uv pip uninstall zha
          uv pip uninstall zhong-hong-hvac
          uv pip uninstall ziggo-mediabox-xl
          uv pip uninstall zm-py
          uv pip uninstall zwave-js-server-python
          uv pip uninstall zwave-me-ws
          EOF
          chmod +x uninstall.sh
          echo "Created uninstall script"

      - name: Run container and execute uninstall script
        run: |
          docker run --platform linux/arm64 -v $(pwd)/uninstall.sh:/uninstall.sh --name ha-temp ghcr.io/home-assistant/home-assistant:${{ env.HA_VERSION }} /bin/bash /uninstall.sh
          CONTAINER_ID=ha-temp
          echo "CONTAINER_ID=${CONTAINER_ID}" >> $GITHUB_ENV
          echo "Uninstall script completed successfully"

      - name: Export container to tar file
        run: |
          docker export ${CONTAINER_ID} > home-assistant-arm64-slim_${{ env.HA_VERSION }}.tar
          echo "Exported container to home-assistant-arm64-slim_${{ env.HA_VERSION }}.tar"

      - name: Stop and remove container
        run: |
          docker stop ${CONTAINER_ID}
          docker rm ${CONTAINER_ID}
          echo "Stopped and removed container"

      - name: Import tar as new image
        run: |
          docker import --platform linux/arm64 \
            --change "WORKDIR ${{ env.ORIGINAL_WORKDIR }}" \
            --change "ENTRYPOINT ${{ env.ORIGINAL_ENTRYPOINT }}" \
            home-assistant-arm64-slim_${{ env.HA_VERSION }}.tar home-assistant-arm64-slim:${{ env.HA_VERSION }}
          echo "Imported tar as home-assistant-arm64-slim:${{ env.HA_VERSION }}"

      - name: Get new image size
        run: |
          NEW_SIZE=$(docker images --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}" home-assistant-arm64-slim:${{ env.HA_VERSION }} | tail -n 1 | awk '{print $2}')
          echo "NEW_SIZE=${NEW_SIZE}" >> $GITHUB_ENV
          echo "新镜像大小: ${NEW_SIZE}"

      - name: Calculate size reduction percentage
        run: |
          # Convert sizes to bytes for calculation
          ORIGINAL_SIZE_BYTES=$(echo "${{ env.ORIGINAL_SIZE }}" | sed 's/GB/*1024*1024*1024/g; s/MB/*1024*1024/g; s/KB/*1024/g; s/B//g' | bc)
          NEW_SIZE_BYTES=$(echo "${{ env.NEW_SIZE }}" | sed 's/GB/*1024*1024*1024/g; s/MB/*1024*1024/g; s/KB/*1024/g; s/B//g' | bc)
          
          # Calculate percentage reduction
          REDUCTION=$(echo "scale=2; ((${ORIGINAL_SIZE_BYTES} - ${NEW_SIZE_BYTES}) * 100) / ${ORIGINAL_SIZE_BYTES}" | bc)
          echo "SIZE_REDUCTION=${REDUCTION}%" >> $GITHUB_ENV
          echo "镜像大小减少: ${REDUCTION}%"

      - name: Create builder with docker-container driver
        run: |
          # Create a new builder with docker-container driver
          docker buildx create --use --driver docker-container --name container-builder
          echo "BUILDER_NAME=container-builder" >> $GITHUB_ENV

      - name: Tag and push local image directly
        run: |
          # Convert repository name to lowercase
          REPO_NAME=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')
          
          # Tag the local image for GitHub Container Registry
          docker tag home-assistant-arm64-slim:${{ env.HA_VERSION }} ghcr.io/${REPO_NAME}:${{ env.HA_VERSION }}
          
          # Push the image directly
          docker push ghcr.io/${REPO_NAME}:${{ env.HA_VERSION }}
          echo "Pushed image to GitHub Container Registry"
          echo "镜像已推送到GitHub Container Registry，可以使用以下命令拉取："
          echo "docker pull ghcr.io/${REPO_NAME}:${{ env.HA_VERSION }}"

      - name: Output final message
        run: |
          echo "镜像已推送到GitHub Container Registry，可以使用以下命令拉取："
          echo "docker pull ghcr.io/${{ github.repository }}:${{ env.HA_VERSION }}"